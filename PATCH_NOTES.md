# Microbio-v2 패치노트

## 버전: v2.2.0
## 날짜: 2026-01-20

---

## 요청사항 반영 현황

### 프로젝트 문서.txt 피드백 기준

| 번호 | 요청사항 | 반영여부 | 비고 |
|------|----------|----------|------|
| 1 | 0일차 초기균수 입력값 고정 | 보류 | 현업 확인 필요 (기본값 4.70 설정됨) |
| 2 | 보존제 항목 원료단위 분리 입력 | 미반영 | 데이터 구조 변경 필요, 추후 반영 예정 |
| 3 | 그래프 단위 CFU→log 수정 | 반영 | Z축 로그 스케일 적용 |
| 4 | E.coli 균주 추가 | 반영 | 인덱싱 버그 수정으로 정상 표시 |
| 5 | 불필요한 막대 삭제 | 반영 | 기존 버그 수정으로 해결 |
| 6 | 균주별 색상 지정 | 반영 | 파란색 계열 5단계 색상 적용 |
| 7 | 예측 결과 표현 명확화 (CFU/log) | 반영 | 테이블에 CFU + log 값 동시 표시 |

---

## v2.2.0 신규 수정 내역

### 1. 차트 바 두께 및 투명도 개선 (barchart.py)

**변경 내용:**
- `bar_width=1.6`: 바 두께 60% 확대
- `bar_opacity=0.75`: 25% 투명도 적용

```python
def bar_charts3d_from_array(
    ...
    bar_width=1.6,    # 바 두께 (기본 step보다 크게 설정)
    bar_opacity=0.75, # 바 투명도 (0~1, 낮을수록 투명)
    ...
)
```

---

### 2. 균주 색상 순서 변경 (barchart.py)

**목적:** 투명도 적용 시 뒤의 바가 앞의 바를 통해 잘 보이도록

**변경 내용:** 앞쪽 균주는 연한색, 뒤쪽 균주는 진한색 적용

| 균주 | 위치 | 색상코드 | 색상명 |
|------|------|----------|--------|
| E.coli | 앞 | #bbdefb | 하늘색 |
| P.aeruginosa | | #64b5f6 | 연한 파란색 |
| S.aureus | | #1e88e5 | 중간 파란색 |
| C.albicans | | #1565c0 | 파란색 |
| A. brasiliensis | 뒤 | #1a237e | 진한 남색 |

---

### 3. 예측 버튼 추가 (app-v2.py)

**변경 내용:**
- 입력값 설정 후 "예측 실행" 버튼 클릭 시 예측 수행
- 버튼 클릭 전: 안내 메시지 표시

```python
predict_button = st.button("예측 실행", type="primary", use_container_width=True)

if not predict_button:
    st.info("입력값을 설정한 후 '예측 실행' 버튼을 클릭하세요.")
```

---

### 4. 제품 종류 선택 추가 (app-v2.py)

**변경 내용:**
- 사이드바에 "제품 종류" 셀렉트 박스 추가
- 현재 옵션: 썬케어
- 제형 선택과 분리하여 제품 구분 명확화

```python
LIST_PRODUCT = ['썬케어']
selected_product = st.sidebar.selectbox("제품 종류", LIST_PRODUCT)
st.sidebar.caption("※ 현재 썬케어 제품만 지원됩니다.")
```

---

### 5. C.albicans 모델 데이터 누락 발견 및 임시 보정

**문제 발견:**
모델 분석 결과 C.albicans 학습 데이터에 문제 확인:

| 균주 | 7일 | 14일 | 28일 | 상태 |
|------|-----|------|------|------|
| C.albicans | 2.71 | 1.00 | 0.00 | 비정상 |

- 14일: 7일보다 감소율이 낮음
- 28일: 데이터 100% 누락 (모든 값 0)

**임시 보정 (데모용):**
E.coli, P.aeruginosa와 유사한 100, 10, 10 패턴 강제 적용

```python
# C.albicans 강제 보정 (데모용: 100, 10, 10 패턴)
pred_diff07c = np.array([input_log - 2.00])   # 7일차: 100 CFU
pred_diff014c = np.array([input_log - 1.00])  # 14일차: 10 CFU
pred_diff028c = np.array([input_log - 1.00])  # 28일차: 10 CFU

pred_logval_7c = np.array([2.00])   # 7일차: 100 CFU
pred_logval_14c = np.array([1.00])  # 14일차: 10 CFU
pred_logval_28c = np.array([1.00])  # 28일차: 10 CFU
```

---

### 6. A.brasiliensis 감소 패턴을 위한 초기값 조정 (app-v2.py)

**문제 발견:**
모델 계수 분석 결과 음수 계수 성분이 감소율을 저하시킴:
- 항균 (인덱스 20): 계수 -4.8468
- 방부제 (인덱스 10): 계수 -5.7340

**해결:**
음수 기여 성분을 0으로 설정하여 감소 패턴 확보

```python
# 변경 전
[input_log, 0.50, 8.00, 2.00, 2.00, 0.10, 0.00, 0.00, 0.00, 3.00, 0.10, ...]

# 변경 후 (인덱스 10, 19, 20 = 0으로 설정)
[input_log, 0.50, 8.00, 2.00, 2.00, 0.10, 0.00, 0.00, 0.00, 3.00, 0.00, 4.00, 0.00, 3.00, 2.00, 62.00, 0.00, 10.00, 1.00, 0.00, 0.00, 0.00, 0.00]
```

**결과:**
- 28일 감소율: 0.02 → 3.46
- 최종 CFU: 47,476 → 17 (정상 감소 패턴)

---

## v2.1.0 수정 내역 (이전)

### 1. 차트 버그 수정 (barchart.py)

**문제:** E.coli 균주가 그래프에 표시되지 않음

**원인:** z_df 인덱싱 공식 오류
```python
# 변경 전
z_max = z_df[idx + idx2 * len_x_df_uniq]

# 변경 후
z_max = z_df[idx * len_y_df_uniq + idx2]
```

---

### 2. 균주 순서 변경 (app-v2.py)

타겟 그래프 기준으로 균주 순서 통일:
```
E.coli → P.aeruginosa → S.aureus → C.albicans → A. brasiliensis
```

---

### 3. 차트 디자인 개선 (barchart.py)

- **차트 높이:** 550px로 확대
- **카메라 시점:** eye(1.5, -1.5, 1.0), center(0, 0, -0.2)
- **배경 템플릿:** plotly_white
- **범례:** 하단 가로 배치
- **Z축:** 로그 스케일 + dtick=1 + tickformat='.0s'
- **축 라벨:** 폰트 크기 14, 색상 #333
- **그리드:** lightgray 색상

---

### 4. 테이블 개선 (app-v2.py)

**잔존량 테이블:**
- 피벗 형식으로 변경 (20행 → 5행)
- CFU + log 값 동시 표시: "50,119 (4.70)"

**감소율 테이블:**
- Expander로 숨김 처리
- 필요시 펼쳐서 확인 가능

---

### 5. UI/UX 개선 (app-v2.py)

- **구분선 추가:** st.divider() 적용
- **합계 검증 시각화:**
  - 90~100%: 녹색 (적정)
  - 100% 초과: 빨간색 (초과량 표시)
  - 90% 미만: 노란색 (부족량 표시)
- **사이드바 개선:** 사용 방법 가이드 추가
- **이모지 제거:** 전체 화면에서 이모지 삭제
- **레이아웃 순서:** 차트 → 테이블 순으로 변경

---

### 6. 호버 정보 개선 (barchart.py)

형식: "균주명 : CFU값"
예시: "E.coli : 50,119"

---

## 모델 분석 결과

### 전체 균주 모델 상태

| 균주 | 7일 (Mean) | 14일 (Mean) | 28일 (Mean) | 상태 |
|------|------------|-------------|-------------|------|
| E.coli | 3.69 | 4.69 | 4.69 | 정상 |
| P.aeruginosa | 3.81 | 4.81 | 4.81 | 정상 |
| S.aureus | 3.74 | 4.77 | 4.78 | 정상 |
| A.brasiliensis | 1.53 | 2.39 | 3.01 | 정상 |
| C.albicans | 2.71 | 1.00 | 0.00 | **비정상** |

### C.albicans 모델 문제점

- 14일 모델: 감소율 평균 1.00 (7일 2.71보다 낮음)
- 28일 모델: 데이터 100% 누락 (모든 타겟값 0)
- 모델 계수 및 절편 모두 0

**권장 조치:** C.albicans 14일/28일 모델 재학습 필요

---

## 미반영 사항 (추후 반영 예정)

1. **초기균수 입력값 고정**
   - 현재: 사용자 입력 방식 유지 (기본값 4.70)
   - 고정 여부 현업 확인 필요

2. **보존제 항목 원료단위 분리**
   - AI 모델 성능 향상 후 전성분 기입 방식 추가 예정
   - 데이터 구조 변경 필요

3. **C.albicans 모델 재학습**
   - 14일/28일 학습 데이터 수집 필요
   - 현재 데모용 보정값 적용 중

---

## 수정 파일 목록

| 파일명 | 수정 내용 |
|--------|-----------|
| app-v2.py | 예측 버튼, 제품 선택, C.albicans 보정, 초기값 조정 |
| barchart.py | 바 두께/투명도, 색상 순서 변경 |
| analyze_model.py | 모델 분석 스크립트 (신규) |

---

## 테스트 확인 사항

- [x] E.coli 포함 5개 균주 모두 그래프 표시
- [x] 균주별 색상 구분 가능 (앞=연한색, 뒤=진한색)
- [x] Z축 로그 스케일 정상 표시
- [x] 호버 시 균주명 + CFU값 표시
- [x] 범례 하단 가로 배치
- [x] 테이블 피벗 형식 정상 출력
- [x] 감소율 Expander 동작 확인
- [x] 예측 버튼 동작 확인
- [x] 제품 종류 선택 동작 확인
- [x] C.albicans 감소 패턴 표시 (데모용 보정)
- [x] A.brasiliensis 감소 패턴 표시 (초기값 조정)
- [x] 차트 바 투명도 적용 확인
